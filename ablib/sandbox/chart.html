<!DOCTYPE HTML>
<!-- http://stackoverflow.com/questions/15113692/showing-highcharts-in-a-jquery-mobile-application -->
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Highcharts Example</title>
		
		<!-- 1. Add these JavaScript inclusions in the head of your page -->
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
		<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>		
		<script type="text/javascript">
			
			Highcharts.setOptions({
				global: {
					useUTC: false
				}
			});
				
			var chart;			
			var ws = new WebSocket("ws://127.0.0.1:8888/track");
			function open_websocket(){
					console.log('open_websocket()');
	        		
	        		function show_message(message){
	        			var el = document.getElementById('wsmsg');
	        			el.innerHTML = message;        			
	        			//console.log('message: ' + message);
	        			var json_data;
	        			try{
	        				json_data = JSON.parse(message);
	        				power_W = json_data;
	        				//console.log('power_W = ' + power_W);
	        				var series = chart.series[0];
	        				series_data = series.data[series.data.length - 1];
	        				//console.log('series.data= ' + series_data.x);
	        				series.addPoint([series_data.x+1, power_W], true, true);
	        			}
	        			catch(e){
	        					console.log('JSON.parse error: "' + e +'"');
	        				}
	        		}
		            
		            ws.onopen = function() {
		            	console.log('onopen()');
		                show_message('Connected.');
		            };
		            ws.onmessage = function(event) {	            	
		            	console.log('onmessage(' + event.data + ')');
		            	show_message(event.data);

		            };
		            ws.onclose = function() {
		            	console.log('onclose()');
		            	show_message("Closed.");
		            };
	        	}

			$(document).ready(function() {
				console.log('Document ready function start');
				open_websocket();
				console.log('Creating a new Highcharts');
				chart = new Highcharts.Chart({
					chart: {
						renderTo: 'container',
						defaultSeriesType: 'spline',
						marginRight: 10,
						events: {
							load: function() {
				
								// set up the updating of the chart each second
								var series = this.series[0];
								// setInterval(function() {
								// 	var x = (new Date()).getTime(), // current time
								// 		y = Math.random();
								// 	series.addPoint([x, y], true, true);
								// }, 1000);
							}
						}
					},
					title: {
						text: 'Real time hydro consumption'
					},
					xAxis: {
						 type: 'linear',
						 //tickPixelInterval: 150
					},
					yAxis: {
						title: {
							text: 'Power [W]'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}]
					},
					// tooltip: {
					// 	formatter: function() {
				 //                return '<b>'+ this.series.name +'</b><br/>'+
					// 			Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) +'<br/>'+ 
					// 			Highcharts.numberFormat(this.y, 2);
					// 	}
					// },
					legend: {
						enabled: false
					},
					exporting: {
						enabled: false
					},
					series: [{
						name: 'Power [W]',
						data: (function() {
							// generate an array of random data
							var data = [],i;
							
							for (i = 0; i <= 400; i++) {
								data.push({
									x: i,
									y: 0,
								});
							}
							return data;
						})()
					}]
				});
				
			
			$("#get_ber").click(function(){
				$.post( "/msg" );
			});

			});
				
		</script>
		
	</head>
	<body>
		<!-- 3. Add the container -->
		<!-- <div id="container" style="width: 800px; height: 400px; margin: 0 auto"></div> -->
		<div id="container" style="height: 400px; margin: 0 auto"></div>
		<button id='get_ber' type="button">GetBer</button>
		<h2>Messages</h2>
		<p id='wsmsg'>ws-msg</p>
        <hr/>
	</body>
</html>
